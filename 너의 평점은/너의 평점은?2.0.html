<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 평점은? - 소셜 파티 게임</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.9;
            font-weight: 300;
        }

        .role-selection {
            margin-bottom: 20px;
        }

        .role-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
            font-weight: 400;
        }

        .role-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .input-group {
            margin: 20px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-family: 'Roboto', monospace;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            width: 100%;
            font-weight: 400;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #ff6b6b;
        }

        .btn-secondary:hover {
            background: #ff5252;
        }

        .btn-warning {
            background: #ff9800;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-info {
            background: #2196F3;
        }

        .btn-info:hover {
            background: #1976D2;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn-confirm {
            background: #ff5722;
            animation: pulse 1s infinite;
        }

        .btn-confirm:hover {
            background: #e64a19;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 5px;
            width: auto;
            min-width: 40px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes numberChange {
            0% { 
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
            50% { 
                transform: scale(1.2) rotateY(180deg);
                opacity: 0.7;
            }
            100% { 
                transform: scale(1) rotateY(360deg);
                opacity: 1;
            }
        }

        @keyframes sparkle {
            0%, 100% { 
                opacity: 0;
                transform: scale(0);
            }
            50% { 
                opacity: 1;
                transform: scale(1);
            }
        }

        .number-changing {
            animation: numberChange 0.8s ease-in-out;
        }

        .sparkle-effect {
            position: relative;
        }

        .sparkle-effect::before,
        .sparkle-effect::after {
            content: "✨";
            position: absolute;
            font-size: 0.8em;
            animation: sparkle 1s ease-in-out;
        }

        .sparkle-effect::before {
            top: -10px;
            left: -20px;
            animation-delay: 0.2s;
        }

        .sparkle-effect::after {
            top: -10px;
            right: -20px;
            animation-delay: 0.4s;
        }

        .qr-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: inline-block;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .qr-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            color: #333;
        }

        .token {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin: 15px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 12px;
            font-family: 'Roboto', monospace;
            letter-spacing: 4px;
        }

        .game-status {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .round-info {
            font-size: 1.5em;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 15px;
        }

        .round-controls {
            margin-top: 15px;
        }

        .scoreboard {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .score-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-display {
            font-size: 1.2em;
            font-weight: 700;
            color: #FFD700;
            min-width: 30px;
        }

        .player-name {
            font-weight: 700;
            color: white;
        }

        .current-turn {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
        }

        .host-number {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .host-secret {
            font-size: 3em;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .rules {
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .rules h3 {
            color: #FFD700;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .rules ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .rules li {
            margin: 8px 0;
            line-height: 1.4;
            font-weight: 300;
        }

        .example-box {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }

        .secret-number {
            font-size: 4em;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            border: 3px solid #FFD700;
            transition: all 0.3s ease;
        }

        .player-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 400;
        }

        .player-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .subject-generator {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .current-subject {
            font-size: 1.5em;
            font-weight: 700;
            color: #FFD700;
            margin: 15px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 2px solid #FFD700;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reveal-section {
            background: rgba(255, 69, 58, 0.1);
            border: 2px solid #FF453A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .reveal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reveal-round-info {
            font-size: 1.1em;
            font-weight: 700;
            color: #FFD700;
        }

        .revealed-numbers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .revealed-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            font-weight: 400;
        }

        .revealed-item .player-name {
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .revealed-item .secret-num {
            font-size: 1.5em;
            font-weight: 700;
            color: #4CAF50;
        }

        .warning-text {
            color: #FFC107;
            font-weight: 700;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            width: 50px;
            height: 50px;
            font-weight: 400;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
                max-width: 95%;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .qr-grid {
                grid-template-columns: 1fr;
            }

            .score-item {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn hidden" id="backBtn" onclick="goBack()">←</button>
    
    <div class="container">
        <!-- 시작 화면 -->
        <div id="welcomeScreen">
            <h1>🎲 나의 평점은?</h1>
            <p class="subtitle">최고의 소셜 파티 게임</p>
            
            <div class="role-selection">
                <button class="role-btn" onclick="selectRole('host')">
                    🎯 나는 호스트
                </button>
                <button class="role-btn" onclick="selectRole('player')">
                    🎮 나는 플레이어
                </button>
            </div>
        </div>

        <!-- 호스트 설정 화면 -->
        <div id="hostScreen" class="hidden">
            <h2>🎯 호스트 설정</h2>
            <div class="input-group">
                <label for="playerCount">다른 플레이어 수 (호스트 제외):</label>
                <input type="number" id="playerCount" min="1" max="50" value="3">
                <small>원하는 만큼 많은 플레이어를 추가할 수 있어요!</small>
            </div>
            <button class="btn" onclick="generateCodes()">플레이어 코드 생성</button>
        </div>

        <!-- 호스트 코드 표시 화면 -->
        <div id="hostCodesScreen" class="hidden">
            <h2>🎯 플레이어 코드 생성 완료</h2>
            <p>이 코드들을 플레이어들에게 나누어 주세요:</p>
            <div id="codesContainer"></div>
            
            <!-- QR 코드 섹션 -->
            <div class="qr-section">
                <h3>📱 QR 코드로 빠른 입장</h3>
                <p>플레이어들이 스캔해서 입장할 수 있어요:</p>
                <button class="btn btn-info" onclick="toggleQRCode()">
                    <span id="qrToggleText">QR 코드 보기</span>
                </button>
                <div class="qr-code-container hidden" id="qrCodeContainer">
                    <canvas id="qrCanvas"></canvas>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="startGame()">게임 시작</button>
            <button class="btn btn-secondary" onclick="goBack()">설정으로 돌아가기</button>
        </div>

        <!-- 호스트 메인 게임 화면 -->
        <div id="hostGameScreen" class="hidden">
            <h2>🎯 호스트 게임 컨트롤</h2>
            
            <!-- 게임 상태 -->
            <div class="game-status">
                <div class="round-info"><span id="currentRound">1</span>라운드</div>
                <div class="round-controls">
                    <button class="btn btn-info" id="nextRoundBtn" onclick="confirmNextRound()">
                        다음 라운드
                    </button>
                </div>
            </div>

            <!-- 주제 생성기 -->
            <div class="subject-generator">
                <h3>🎲 <span id="categoryPlayerName">플레이어 1</span>을 위한 카테고리</h3>
                <div class="current-subject" id="currentSubject">아래 버튼을 눌러 카테고리를 생성하세요!</div>
                <button class="btn btn-info" onclick="generateRandomSubject()">새 카테고리 생성</button>
            </div>

            <!-- 호스트 번호 표시 -->
            <div class="host-number hidden" id="hostNumberDisplay">
                <h3>🤫 당신의 비밀 번호 (<span id="hostRoundDisplay">1</span>라운드)</h3>
                <div class="host-secret" id="hostSecret">?</div>
                <button class="btn btn-warning" onclick="hideHostNumber()">번호 숨기기</button>
            </div>
            <button class="btn btn-warning" id="hostRevealBtn" onclick="confirmHostReveal()">
                이번 라운드 내 번호 보기
            </button>

            <!-- 점수판 -->
            <div class="scoreboard">
                <h3>🏆 점수판</h3>
                <div id="scoreboardContainer"></div>
            </div>

            <!-- 게임 컨트롤 -->
            <div class="game-controls">
                <button class="btn btn-success" onclick="nextTurn()">다음 플레이어 차례</button>
            </div>

            <!-- 긴급 공개 -->
            <div class="reveal-section">
                <div class="reveal-header">
                    <div>
                        <h3>🔍 긴급 공개</h3>
                        <p class="warning-text">⚠️ 필요할 때만 사용하세요!</p>
                    </div>
                    <div class="reveal-round-info"><span id="revealRoundDisplay">1</span>라운드</div>
                </div>
                
                <button class="btn btn-danger" id="playersRevealBtn" onclick="confirmPlayersReveal()">
                    모든 번호 공개 (현재 라운드)
                </button>
                
                <div id="revealedNumbers" class="revealed-numbers hidden"></div>
                
                <button class="btn btn-secondary hidden" id="hideRevealBtn" onclick="hideRevealedNumbers()">
                    공개된 번호 숨기기
                </button>
            </div>
        </div>

        <!-- 플레이어 입장 화면 -->
        <div id="playerScreen" class="hidden">
            <h2>🎮 플레이어 입장</h2>
            <div class="input-group">
                <label for="playerToken">4글자 코드를 입력하세요:</label>
                <input type="text" id="playerToken" placeholder="예: ABCD" style="text-transform: uppercase;" maxlength="4">
            </div>
            <button class="btn" onclick="validateToken()">게임 참여</button>
        </div>

        <!-- 플레이어 게임 화면 -->
        <div id="playerGameScreen" class="hidden">
            <h2>🎮 <span id="playerTitle">플레이어 #</span></h2>
            
            <div class="game-status">
                <div class="round-info"><span id="playerCurrentRound">1</span>라운드</div>
            </div>

            <div class="player-info">
                <div class="player-number">이번 라운드 당신의 번호</div>
                <div class="secret-number" id="playerSecretNumber">?</div>
                <p>당신의 차례가 되면, 발표된 카테고리에서 이 번호만큼 평점을 줄 만한 것을 말하세요!</p>
            </div>

            <div class="rules">
                <h3>🎯 점수 규칙</h3>
                <ul>
                    <li>다른 사람이 당신의 번호를 맞히면: <strong>맞힌 사람 수만큼 +1점</strong></li>
                    <li>당신이 다른 사람의 번호를 맞히면: <strong>+1점</strong></li>
                    <li><strong>단,</strong> 모든 사람이 당신의 번호를 맞히면 당신은 0점 (너무 뻔하면 안 돼요!)</li>
                </ul>
            </div>

            <button class="btn btn-info" id="playerNextRoundBtn" onclick="confirmPlayerNextRound()">다음 라운드</button>
        </div>

        <!-- 게임 규칙 화면 -->
        <div id="rulesScreen" class="hidden">
            <h2>📋 게임 방법</h2>
            
            <div class="player-info">
                <div class="player-number" id="playerNumberDisplay">당신은 플레이어 #</div>
                <p>플레이어 번호를 기억하세요!</p>
            </div>
            
            <div class="rules">
                <h3>🎯 목표</h3>
                <p>다른 플레이어들의 답변을 듣고 그들의 비밀 번호를 맞춰보세요!</p>
                
                <h3>🎮 게임 진행</h3>
                <ul>
                    <li>매 라운드마다 모든 사람이 1-10 사이의 비밀 번호를 받아요</li>
                    <li>플레이어들이 순서대로 진행해요 (플레이어 1, 2, 3... 그다음 호스트)</li>
                    <li>호스트가 현재 플레이어를 위한 카테고리를 발표해요</li>
                    <li><strong>현재 플레이어는 자신의 비밀 번호만큼 평점을 줄 만한 것을 말해요</strong></li>
                    <li>다른 모든 사람들이 그 플레이어의 비밀 번호를 추측해요</li>
                    <li>맞힌 정도에 따라 점수를 받아요</li>
                </ul>
                
                <h3>🏆 점수 계산</h3>
                <ul>
                    <li><strong>정답 맞히기:</strong> +1점</li>
                    <li><strong>누군가 당신의 번호를 맞히기:</strong> 맞힌 사람 수만큼 +1점</li>
                    <li><strong>단, 모든 사람이 맞히면:</strong> 당신은 0점 (너무 뻔한 답변 방지)</li>
                </ul>
                
                <div class="example-box">
                    <h3>💡 예시 라운드</h3>
                    <p><strong>카테고리: "영화" - 플레이어 A의 차례 (비밀번호: 7)</strong></p>
                    <p><strong>플레이어 A가 말함:</strong> "스파이더맨" (자신이 7/10점 줄 만한 영화)</p>
                    <p><strong>다른 사람들의 추측:</strong> 플레이어 B는 8, 플레이어 C는 7, 호스트는 6으로 추측</p>
                    <p><strong>결과:</strong> 플레이어 C가 +1점, 플레이어 A가 +1점 (플레이어 C가 맞혔으므로)</p>
                </div>
            </div>
            <button class="btn" onclick="enterGame()">게임 시작!</button>
        </div>
    </div>

    <!-- QR 코드 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        let currentScreen = 'welcome';
        let playerTokens = {};
        let currentPlayerNumber = null;
        let currentPlayerToken = null;
        let hostSecretNumbers = []; // 모든 라운드용 배열
        let hostRevealState = 'initial';
        let playersRevealState = 'initial';
        let nextRoundState = 'initial';
        let playerNextRoundState = 'initial';
        let playerCurrentRound = 1; // 독립적인 플레이어 라운드 카운터
        let gameState = {
            currentRound: 1,
            currentTurn: 1, // 1 = 플레이어 1, 2 = 플레이어 2, 등등, 0 = 호스트
            maxPlayers: 0,
            scores: {},
            maxRounds: 10
        };

        // 사용 가능한 글자들 (I와 L 제외)
        const AVAILABLE_LETTERS = 'ABCDEFGHJKMNOPQRSTUVWXYZ'; // 24글자

        // 카테고리 목록
        const categories = [
            "영화", "드라마", "노래", "게임", "책", "배우/여배우", "가수/그룹", 
            "애니메이션", "유튜버", "팟캐스트", "음식", "디저트", "피자 토핑", "음료", "식당", 
            "아이스크림 맛", "아침식사", "간식", "패스트푸드", "요리", "스포츠", 
            "취미", "운동", "파티게임", "주말활동", "여행지", 
            "보드게임", "야외활동", "예술", "춤", "학교과목", "직업", 
            "동물", "색깔", "계절", "날씨", "교통수단", "앱", "SNS", 
            "의류브랜드", "초능력", "디즈니 캐릭터", "자동차 브랜드", "나라", "연예인", 
            "패션 트렌드", "방 인테리어", "공부방법", "아침루틴", "감정"
        ];

        /**
         * 스마트 알고리즘: 4글자 코드를 시드로 변환하여 결정적 랜덤 번호 생성
         */
        
        function generateSimpleToken() {
            // 4개의 랜덤 글자만 생성
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += AVAILABLE_LETTERS[Math.floor(Math.random() * AVAILABLE_LETTERS.length)];
            }
            return code;
        }

        function codeToSeed(fourLetterCode) {
            // 4글자 코드를 24진법 숫자로 변환하여 시드로 사용
            let seed = 0;
            for (let i = 0; i < fourLetterCode.length; i++) {
                const letterIndex = AVAILABLE_LETTERS.indexOf(fourLetterCode[i]);
                seed = seed * 24 + letterIndex;
            }
            // 시드가 양수이고 적절하도록 보장
            return Math.abs(seed) + 1;
        }

        function seedRandom(seed) {
            // 결정적 랜덤 번호를 위한 간단한 선형 합동 생성기
            let state = seed;
            return function() {
                state = (state * 1664525 + 1013904223) % Math.pow(2, 32);
                return (state / Math.pow(2, 32));
            };
        }

        function generateSecretNumbers(fourLetterCode, maxRounds) {
            const seed = codeToSeed(fourLetterCode);
            const rng = seedRandom(seed);
            
            const secretNumbers = [];
            for (let i = 0; i < maxRounds; i++) {
                // 1-10 사이 번호 생성
                const number = Math.floor(rng() * 10) + 1;
                secretNumbers.push(number);
            }
            return secretNumbers;
        }

        function decodeToken(token) {
            if (!token || token.length !== 4) {
                return null;
            }
            
            // 모든 글자가 유효한지 확인
            for (let letter of token) {
                if (!AVAILABLE_LETTERS.includes(letter)) {
                    return null;
                }
            }
            
            return generateSecretNumbers(token, gameState.maxRounds);
        }

        function selectRole(role) {
            currentScreen = role;
            hideAllScreens();
            
            if (role === 'host') {
                document.getElementById('hostScreen').classList.remove('hidden');
            } else {
                document.getElementById('playerScreen').classList.remove('hidden');
            }
            
            showBackButton();
        }

        function generateCodes() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            
            if (playerCount < 1 || playerCount > 50) {
                alert('1명에서 50명 사이의 숫자를 입력해주세요.');
                return;
            }

            playerTokens = {};
            gameState.maxPlayers = playerCount;
            gameState.scores = { '호스트': 0 };

            // 랜덤 4글자 코드를 사용하여 호스트 비밀 번호 생성
            const hostCode = Array.from({length: 4}, () => 
                AVAILABLE_LETTERS[Math.floor(Math.random() * AVAILABLE_LETTERS.length)]
            ).join('');
            hostSecretNumbers = generateSecretNumbers(hostCode, gameState.maxRounds);

            // 다른 플레이어들을 위한 토큰 생성
            for (let i = 1; i <= playerCount; i++) {
                const token = generateSimpleToken();
                const secretNumbers = generateSecretNumbers(token, gameState.maxRounds);
                
                playerTokens[token] = {
                    playerNumber: i,
                    secretNumbers: secretNumbers
                };
                
                gameState.scores[`플레이어 ${i}`] = 0;
            }

            showCodesScreen();
        }

        function showCodesScreen() {
            const codesContainer = document.getElementById('codesContainer');
            codesContainer.innerHTML = '';

            // 4글자만으로 모든 플레이어 코드 표시
            for (const [token, data] of Object.entries(playerTokens)) {
                const codeItem = document.createElement('div');
                codeItem.className = 'qr-item';
                codeItem.innerHTML = `
                    <h3>플레이어 ${data.playerNumber}</h3>
                    <div class="token">${token}</div>
                    <small>이 코드를 플레이어 ${data.playerNumber}에게 주세요</small>
                `;
                codesContainer.appendChild(codeItem);
            }

            generateQRCode();
            
            hideAllScreens();
            document.getElementById('hostCodesScreen').classList.remove('hidden');
            currentScreen = 'hostCodes';
        }

        function startGame() {
            hideAllScreens();
            document.getElementById('hostGameScreen').classList.remove('hidden');
            currentScreen = 'hostGame';
            
            updateGameDisplay();
            updateScoreboard();
        }

        function updateGameDisplay() {
            document.getElementById('currentRound').textContent = gameState.currentRound;
            document.getElementById('hostRoundDisplay').textContent = gameState.currentRound;
            document.getElementById('revealRoundDisplay').textContent = gameState.currentRound;
            
            const currentPlayerName = gameState.currentTurn === 0 ? '호스트' : `플레이어 ${gameState.currentTurn}`;
            document.getElementById('categoryPlayerName').textContent = currentPlayerName;
            
            // 호스트의 현재 번호 업데이트
            document.getElementById('hostSecret').textContent = hostSecretNumbers[gameState.currentRound - 1];
            
            resetHostRevealButton();
            resetNextRoundButton();
        }

        function generateQRCode() {
            const currentURL = window.location.href;
            const canvas = document.getElementById('qrCanvas');
            
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(canvas, currentURL, { width: 200 }, function (error) {
                    if (error) console.error('QR 코드 생성 실패:', error);
                });
            } else {
                // QR 라이브러리 로드 실패 시 대체
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                ctx.fillStyle = '#333';
                ctx.fillRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('QR 코드', 100, 90);
                ctx.fillText('로드 실패', 100, 110);
                ctx.fillText('URL 수동 공유', 100, 130);
            }
        }

        function toggleQRCode() {
            const container = document.getElementById('qrCodeContainer');
            const toggleText = document.getElementById('qrToggleText');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                toggleText.textContent = 'QR 코드 숨기기';
            } else {
                container.classList.add('hidden');
                toggleText.textContent = 'QR 코드 보기';
            }
        }

        function updateScoreboard() {
            const container = document.getElementById('scoreboardContainer');
            container.innerHTML = '';
            
            for (const [playerName, score] of Object.entries(gameState.scores)) {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                
                const currentPlayerName = gameState.currentTurn === 0 ? '호스트' : `플레이어 ${gameState.currentTurn}`;
                if (playerName === currentPlayerName) {
                    scoreItem.classList.add('current-turn');
                }
                
                scoreItem.innerHTML = `
                    <div class="player-name">${playerName}</div>
                    <div class="score-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustScore('${playerName}', -1)">-</button>
                        <div class="score-display">${score}</div>
                        <button class="btn btn-success btn-small" onclick="adjustScore('${playerName}', 1)">+</button>
                    </div>
                `;
                
                container.appendChild(scoreItem);
            }
        }

        function adjustScore(playerName, delta) {
            gameState.scores[playerName] = Math.max(0, gameState.scores[playerName] + delta);
            updateScoreboard();
        }

        function nextTurn() {
            gameState.currentTurn++;
            if (gameState.currentTurn > gameState.maxPlayers) {
                gameState.currentTurn = 0; // 호스트 차례
            }
            updateGameDisplay();
            updateScoreboard();
            
            // 현재 주제 지우기
            document.getElementById('currentSubject').textContent = '아래 버튼을 눌러 카테고리를 생성하세요!';
        }

        function confirmNextRound() {
            const btn = document.getElementById('nextRoundBtn');
            
            if (nextRoundState === 'initial') {
                if (gameState.currentRound >= gameState.maxRounds) {
                    alert(`최대 ${gameState.maxRounds}라운드까지 가능합니다!`);
                    return;
                }
                
                nextRoundState = 'confirming';
                btn.textContent = '정말로 하시겠어요? 다시 클릭';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (nextRoundState === 'confirming') {
                        resetNextRoundButton();
                    }
                }, 3000);
                
            } else if (nextRoundState === 'confirming') {
                nextRound();
            }
        }

        function resetNextRoundButton() {
            nextRoundState = 'initial';
            const btn = document.getElementById('nextRoundBtn');
            btn.textContent = '다음 라운드';
            btn.className = 'btn btn-info';
        }

        function nextRound() {
            gameState.currentRound++;
            gameState.currentTurn = 1; // 플레이어 1부터 시작
            updateGameDisplay();
            updateScoreboard();
            
            // 현재 주제 지우기
            document.getElementById('currentSubject').textContent = '아래 버튼을 눌러 카테고리를 생성하세요!';
            
            // 호스트 번호 숨기고 공개 상태 리셋
            document.getElementById('hostNumberDisplay').classList.add('hidden');
            hostRevealState = 'initial';
            resetHostRevealButton();
            
            // 공개된 번호 숨기기
            hideRevealedNumbers();
            playersRevealState = 'initial';
            resetPlayersRevealButton();
        }

        function confirmHostReveal() {
            const btn = document.getElementById('hostRevealBtn');
            
            if (hostRevealState === 'initial') {
                hostRevealState = 'confirming';
                btn.textContent = '정말로 하시겠어요? 다시 클릭해서 공개';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (hostRevealState === 'confirming') {
                        resetHostRevealButton();
                    }
                }, 3000);
                
            } else if (hostRevealState === 'confirming') {
                hostRevealState = 'revealed';
                document.getElementById('hostNumberDisplay').classList.remove('hidden');
                btn.textContent = '번호 공개됨';
                btn.className = 'btn btn-secondary';
                btn.disabled = true;
            }
        }

        function hideHostNumber() {
            document.getElementById('hostNumberDisplay').classList.add('hidden');
            hostRevealState = 'initial';
            resetHostRevealButton();
        }

        function resetHostRevealButton() {
            hostRevealState = 'initial';
            const btn = document.getElementById('hostRevealBtn');
            btn.textContent = '이번 라운드 내 번호 보기';
            btn.className = 'btn btn-warning';
            btn.disabled = false;
        }

        function confirmPlayersReveal() {
            const btn = document.getElementById('playersRevealBtn');
            
            if (playersRevealState === 'initial') {
                playersRevealState = 'confirming';
                btn.textContent = '정말로 하시겠어요? 다시 클릭해서 모두 공개';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (playersRevealState === 'confirming') {
                        resetPlayersRevealButton();
                    }
                }, 3000);
                
            } else if (playersRevealState === 'confirming') {
                playersRevealState = 'revealed';
                revealAllNumbers();
                btn.textContent = '모든 번호 공개됨';
                btn.className = 'btn btn-secondary';
                btn.disabled = true;
                
                // 숨기기 버튼 보이기
                document.getElementById('hideRevealBtn').classList.remove('hidden');
            }
        }

        function resetPlayersRevealButton() {
            playersRevealState = 'initial';
            const btn = document.getElementById('playersRevealBtn');
            btn.textContent = '모든 번호 공개 (현재 라운드)';
            btn.className = 'btn btn-danger';
            btn.disabled = false;
        }

        function revealAllNumbers() {
            const revealContainer = document.getElementById('revealedNumbers');
            revealContainer.innerHTML = '';
            
            for (const [token, data] of Object.entries(playerTokens)) {
                const currentNumber = data.secretNumbers[gameState.currentRound - 1];
                const revealItem = document.createElement('div');
                revealItem.className = 'revealed-item';
                revealItem.innerHTML = `
                    <div class="player-name">플레이어 ${data.playerNumber}</div>
                    <div class="secret-num">${currentNumber}</div>
                    <small>${gameState.currentRound}라운드</small>
                `;
                revealContainer.appendChild(revealItem);
            }
            
            revealContainer.classList.remove('hidden');
        }

        function hideRevealedNumbers() {
            document.getElementById('revealedNumbers').classList.add('hidden');
            document.getElementById('hideRevealBtn').classList.add('hidden');
            playersRevealState = 'initial';
            resetPlayersRevealButton();
        }

        function validateToken() {
            const token = document.getElementById('playerToken').value.toUpperCase().trim();
            
            if (!token) {
                alert('4글자 코드를 입력해주세요.');
                return;
            }

            if (token.length !== 4) {
                alert('코드는 정확히 4글자여야 합니다.');
                return;
            }

            // 토큰으로 플레이어 찾기
            let foundPlayer = null;
            for (const [playerToken, data] of Object.entries(playerTokens)) {
                if (playerToken === token) {
                    foundPlayer = data;
                    break;
                }
            }

            if (foundPlayer) {
                currentPlayerNumber = foundPlayer.playerNumber;
                currentPlayerToken = token;
                showRules();
                return;
            }

            // 모든 글자가 유효한지 확인
            let validCode = true;
            for (let letter of token) {
                if (!AVAILABLE_LETTERS.includes(letter)) {
                    validCode = false;
                    break;
                }
            }
            
            if (validCode) {
                // 데모용으로 기본 플레이어 번호 사용
                currentPlayerNumber = 1;
                currentPlayerToken = token;
                showRules();
            } else {
                alert('코드에 잘못된 글자가 있습니다. 다시 확인해주세요.');
            }
        }

        function showRules() {
            hideAllScreens();
            document.getElementById('rulesScreen').classList.remove('hidden');
            document.getElementById('playerNumberDisplay').textContent = `당신은 플레이어 ${currentPlayerNumber}`;
        }

        function enterGame() {
            hideAllScreens();
            document.getElementById('playerGameScreen').classList.remove('hidden');
            document.getElementById('playerTitle').textContent = `플레이어 ${currentPlayerNumber}`;
            playerCurrentRound = 1; // 게임 진입 시 라운드 1로 리셋
            updatePlayerGameDisplay();
        }

        function updatePlayerGameDisplay() {
            let currentNumber;
            
            if (currentPlayerToken && playerTokens[currentPlayerToken]) {
                currentNumber = playerTokens[currentPlayerToken].secretNumbers[playerCurrentRound - 1];
            } else {
                const decodedNumbers = decodeToken(currentPlayerToken);
                currentNumber = decodedNumbers ? decodedNumbers[playerCurrentRound - 1] : Math.floor(Math.random() * 10) + 1;
            }
            
            document.getElementById('playerSecretNumber').textContent = currentNumber;
            document.getElementById('playerCurrentRound').textContent = playerCurrentRound;
        }

        function animateNumberChange() {
            const numberElement = document.getElementById('playerSecretNumber');
            
            // 애니메이션 클래스 추가
            numberElement.classList.add('number-changing', 'sparkle-effect');
            
            // 애니메이션 완료 후 클래스 제거
            setTimeout(() => {
                numberElement.classList.remove('number-changing', 'sparkle-effect');
            }, 1000);
        }

        function confirmPlayerNextRound() {
            const btn = document.getElementById('playerNextRoundBtn');
            
            if (playerNextRoundState === 'initial') {
                if (playerCurrentRound >= gameState.maxRounds) {
                    alert(`최대 ${gameState.maxRounds}라운드까지 가능합니다!`);
                    return;
                }
                
                playerNextRoundState = 'confirming';
                btn.textContent = '정말로 하시겠어요? 다시 클릭';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (playerNextRoundState === 'confirming') {
                        resetPlayerNextRoundButton();
                    }
                }, 3000);
                
            } else if (playerNextRoundState === 'confirming') {
                playerNextRound();
            }
        }

        function resetPlayerNextRoundButton() {
            playerNextRoundState = 'initial';
            const btn = document.getElementById('playerNextRoundBtn');
            btn.textContent = '다음 라운드';
            btn.className = 'btn btn-info';
        }

        function playerNextRound() {
            // 독립적으로 다음 라운드로 진행
            playerCurrentRound++;
            playerNextRoundState = 'initial';
            resetPlayerNextRoundButton();
            
            // 번호 변경 애니메이션
            animateNumberChange();
            
            // 알고리즘에서 새 번호로 화면 업데이트
            setTimeout(() => {
                updatePlayerGameDisplay();
            }, 400); // 애니메이션과 동기화를 위한 지연
        }

        function generateRandomSubject() {
            const randomIndex = Math.floor(Math.random() * categories.length);
            const category = categories[randomIndex];
            document.getElementById('currentSubject').textContent = category;
        }

        function hideAllScreens() {
            const screens = ['welcomeScreen', 'hostScreen', 'hostCodesScreen', 'hostGameScreen', 'playerScreen', 'playerGameScreen', 'rulesScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function showBackButton() {
            document.getElementById('backBtn').classList.remove('hidden');
        }

        function hideBackButton() {
            document.getElementById('backBtn').classList.add('hidden');
        }

        function goBack() {
            if (currentScreen === 'host' || currentScreen === 'player') {
                hideAllScreens();
                hideBackButton();
                document.getElementById('welcomeScreen').classList.remove('hidden');
                currentScreen = 'welcome';
            } else if (currentScreen === 'hostCodes') {
                hideAllScreens();
                document.getElementById('hostScreen').classList.remove('hidden');
                currentScreen = 'host';
            } else if (currentScreen === 'hostGame') {
                hideAllScreens();
                document.getElementById('hostCodesScreen').classList.remove('hidden');
                currentScreen = 'hostCodes';
            } else if (currentScreen === 'rules') {
                hideAllScreens();
                document.getElementById('playerScreen').classList.remove('hidden');
                currentScreen = 'player';
            }
        }

        // 이벤트 리스너
        document.getElementById('playerCount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') generateCodes();
        });

        document.getElementById('playerToken').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') validateToken();
        });

        // 플레이어 토큰 입력을 4글자로만 자동 포맷
        document.getElementById('playerToken').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase();
            
            // 잘못된 문자 제거 - 유효한 글자만 허용
            value = value.replace(/[^ABCDEFGHJKMNOPQRSTUVWXYZ]/g, '');
            
            // 4글자로 제한
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            e.target.value = value;
        });
    </script>
</body>
</html>
