<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What's Your Rating - Social Party Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.9;
            font-weight: 300;
        }

        .role-selection {
            margin-bottom: 20px;
        }

        .role-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
            font-weight: 400;
        }

        .role-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .input-group {
            margin: 20px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-family: 'Roboto', monospace;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            width: 100%;
            font-weight: 400;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #ff6b6b;
        }

        .btn-secondary:hover {
            background: #ff5252;
        }

        .btn-warning {
            background: #ff9800;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-info {
            background: #2196F3;
        }

        .btn-info:hover {
            background: #1976D2;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn-confirm {
            background: #ff5722;
            animation: pulse 1s infinite;
        }

        .btn-confirm:hover {
            background: #e64a19;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 5px;
            width: auto;
            min-width: 40px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes numberChange {
            0% { 
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
            50% { 
                transform: scale(1.2) rotateY(180deg);
                opacity: 0.7;
            }
            100% { 
                transform: scale(1) rotateY(360deg);
                opacity: 1;
            }
        }

        @keyframes sparkle {
            0%, 100% { 
                opacity: 0;
                transform: scale(0);
            }
            50% { 
                opacity: 1;
                transform: scale(1);
            }
        }

        .number-changing {
            animation: numberChange 0.8s ease-in-out;
        }

        .sparkle-effect {
            position: relative;
        }

        .sparkle-effect::before,
        .sparkle-effect::after {
            content: "✨";
            position: absolute;
            font-size: 0.8em;
            animation: sparkle 1s ease-in-out;
        }

        .sparkle-effect::before {
            top: -10px;
            left: -20px;
            animation-delay: 0.2s;
        }

        .sparkle-effect::after {
            top: -10px;
            right: -20px;
            animation-delay: 0.4s;
        }

        .qr-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: inline-block;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .qr-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            color: #333;
        }

        .token {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin: 15px 0;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 12px;
            font-family: 'Roboto', monospace;
            letter-spacing: 4px;
        }

        .game-status {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .round-info {
            font-size: 1.5em;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 15px;
        }

        .round-controls {
            margin-top: 15px;
        }

        .scoreboard {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .score-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-display {
            font-size: 1.2em;
            font-weight: 700;
            color: #FFD700;
            min-width: 30px;
        }

        .player-name {
            font-weight: 700;
            color: white;
        }

        .current-turn {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
        }

        .host-number {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #FFD700;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .host-secret {
            font-size: 3em;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .rules {
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .rules h3 {
            color: #FFD700;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .rules ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .rules li {
            margin: 8px 0;
            line-height: 1.4;
            font-weight: 300;
        }

        .example-box {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }

        .secret-number {
            font-size: 4em;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            border: 3px solid #FFD700;
            transition: all 0.3s ease;
        }

        .player-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 400;
        }

        .player-number {
            font-size: 1.5em;
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .subject-generator {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .current-subject {
            font-size: 1.5em;
            font-weight: 700;
            color: #FFD700;
            margin: 15px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            border: 2px solid #FFD700;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reveal-section {
            background: rgba(255, 69, 58, 0.1);
            border: 2px solid #FF453A;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .reveal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .reveal-round-info {
            font-size: 1.1em;
            font-weight: 700;
            color: #FFD700;
        }

        .revealed-numbers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .revealed-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            font-weight: 400;
        }

        .revealed-item .player-name {
            font-weight: 700;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .revealed-item .secret-num {
            font-size: 1.5em;
            font-weight: 700;
            color: #4CAF50;
        }

        .warning-text {
            color: #FFC107;
            font-weight: 700;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            width: 50px;
            height: 50px;
            font-weight: 400;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
                max-width: 95%;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .qr-grid {
                grid-template-columns: 1fr;
            }

            .score-item {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn hidden" id="backBtn" onclick="goBack()">←</button>
    
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen">
            <h1>🎲 What's Your Rating</h1>
            <p class="subtitle">The Ultimate Social Party Game</p>
            
            <div class="role-selection">
                <button class="role-btn" onclick="selectRole('host')">
                    🎯 I'm the Host
                </button>
                <button class="role-btn" onclick="selectRole('player')">
                    🎮 I'm a Player
                </button>
            </div>
        </div>

        <!-- Host Setup Screen -->
        <div id="hostScreen" class="hidden">
            <h2>🎯 Host Setup</h2>
            <div class="input-group">
                <label for="playerCount">Number of Other Players (excluding you):</label>
                <input type="number" id="playerCount" min="1" max="50" value="3">
                <small>You can have as many players as you want!</small>
            </div>
            <button class="btn" onclick="generateCodes()">Generate Player Codes</button>
        </div>

        <!-- Host Codes Display Screen -->
        <div id="hostCodesScreen" class="hidden">
            <h2>🎯 Player Codes Generated</h2>
            <p>Share these codes with your players:</p>
            <div id="codesContainer"></div>
            
            <!-- QR Code Section -->
            <div class="qr-section">
                <h3>📱 Quick Join with QR Code</h3>
                <p>Players can scan this to join:</p>
                <button class="btn btn-info" onclick="toggleQRCode()">
                    <span id="qrToggleText">Show QR Code</span>
                </button>
                <div class="qr-code-container hidden" id="qrCodeContainer">
                    <canvas id="qrCanvas"></canvas>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="startGame()">Start Game</button>
            <button class="btn btn-secondary" onclick="goBack()">Back to Setup</button>
        </div>

        <!-- Host Main Game Screen -->
        <div id="hostGameScreen" class="hidden">
            <h2>🎯 Host Game Control</h2>
            
            <!-- Game Status -->
            <div class="game-status">
                <div class="round-info">Round <span id="currentRound">1</span></div>
                <div class="round-controls">
                    <button class="btn btn-info" id="nextRoundBtn" onclick="confirmNextRound()">
                        Next Round
                    </button>
                </div>
            </div>

            <!-- Subject Generator -->
            <div class="subject-generator">
                <h3>🎲 Category for <span id="categoryPlayerName">Player 1</span></h3>
                <div class="current-subject" id="currentSubject">Click below to generate a category!</div>
                <button class="btn btn-info" onclick="generateRandomSubject()">Generate New Category</button>
            </div>

            <!-- Host's Number Display -->
            <div class="host-number hidden" id="hostNumberDisplay">
                <h3>🤫 Your Secret Number (Round <span id="hostRoundDisplay">1</span>)</h3>
                <div class="host-secret" id="hostSecret">?</div>
                <button class="btn btn-warning" onclick="hideHostNumber()">Hide Number</button>
            </div>
            <button class="btn btn-warning" id="hostRevealBtn" onclick="confirmHostReveal()">
                Show My Number for This Round
            </button>

            <!-- Scoreboard -->
            <div class="scoreboard">
                <h3>🏆 Scoreboard</h3>
                <div id="scoreboardContainer"></div>
            </div>

            <!-- Game Controls -->
            <div class="game-controls">
                <button class="btn btn-success" onclick="nextTurn()">Next Player's Turn</button>
            </div>

            <!-- Emergency Reveals -->
            <div class="reveal-section">
                <div class="reveal-header">
                    <div>
                        <h3>🔍 Emergency Reveal</h3>
                        <p class="warning-text">⚠️ Only use if needed!</p>
                    </div>
                    <div class="reveal-round-info">Round <span id="revealRoundDisplay">1</span></div>
                </div>
                
                <button class="btn btn-danger" id="playersRevealBtn" onclick="confirmPlayersReveal()">
                    Reveal All Numbers (Current Round)
                </button>
                
                <div id="revealedNumbers" class="revealed-numbers hidden"></div>
                
                <button class="btn btn-secondary hidden" id="hideRevealBtn" onclick="hideRevealedNumbers()">
                    Hide Revealed Numbers
                </button>
            </div>
        </div>

        <!-- Player Entry Screen -->
        <div id="playerScreen" class="hidden">
            <h2>🎮 Player Entry</h2>
            <div class="input-group">
                <label for="playerToken">Enter your 4-letter code:</label>
                <input type="text" id="playerToken" placeholder="e.g., ABCD" style="text-transform: uppercase;" maxlength="4">
            </div>
            <button class="btn" onclick="validateToken()">Join Game</button>
        </div>

        <!-- Player Game Screen -->
        <div id="playerGameScreen" class="hidden">
            <h2>🎮 <span id="playerTitle">Player #</span></h2>
            
            <div class="game-status">
                <div class="round-info">Round <span id="playerCurrentRound">1</span></div>
            </div>

            <div class="player-info">
                <div class="player-number">Your Number This Round</div>
                <div class="secret-number" id="playerSecretNumber">?</div>
                <p>When it's your turn, name something from the announced category that YOU would rate as this number out of 10!</p>
            </div>

            <div class="rules">
                <h3>🎯 Scoring Rules</h3>
                <ul>
                    <li>When others guess your number correctly: <strong>you get +1 point per correct guess</strong></li>
                    <li>When you guess someone's number correctly: <strong>you get +1 point</strong></li>
                    <li><strong>BUT:</strong> If everyone guesses your number correctly, you get 0 points (keep it challenging!)</li>
                </ul>
            </div>

            <button class="btn btn-info" id="playerNextRoundBtn" onclick="confirmPlayerNextRound()">Next Round</button>
        </div>

        <!-- Rules Screen -->
        <div id="rulesScreen" class="hidden">
            <h2>📋 How to Play</h2>
            
            <div class="player-info">
                <div class="player-number" id="playerNumberDisplay">You are Player #</div>
                <p>Remember your player number!</p>
            </div>
            
            <div class="rules">
                <h3>🎯 Objective</h3>
                <p>Guess other players' secret numbers based on their answers!</p>
                
                <h3>🎮 How It Works</h3>
                <ul>
                    <li>Everyone gets a secret number from 1-10 each round</li>
                    <li>Players take turns (Player 1, 2, 3... then Host)</li>
                    <li>Host announces a category for the current player</li>
                    <li><strong>Current player names something they'd rate as their secret number out of 10</strong></li>
                    <li>Everyone else guesses the player's secret number</li>
                    <li>Points are awarded based on correct guesses</li>
                </ul>
                
                <h3>🏆 Scoring</h3>
                <ul>
                    <li><strong>Correct guess:</strong> +1 point</li>
                    <li><strong>Someone guesses your number:</strong> +1 point per correct guess</li>
                    <li><strong>BUT if everyone guesses correctly:</strong> You get 0 points (to prevent obvious answers)</li>
                </ul>
                
                <div class="example-box">
                    <h3>💡 Example Round</h3>
                    <p><strong>Category: "Movies" - Player A's Turn (secret: 7)</strong></p>
                    <p><strong>Player A says:</strong> "Spider-Man" (something they'd rate 7/10)</p>
                    <p><strong>Others guess:</strong> Player B guesses 8, Player C guesses 7, Host guesses 6</p>
                    <p><strong>Result:</strong> Player C gets +1, Player A gets +1 (for Player C's correct guess)</p>
                </div>
            </div>
            <button class="btn" onclick="enterGame()">Start Playing!</button>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        let currentScreen = 'welcome';
        let playerTokens = {};
        let currentPlayerNumber = null;
        let currentPlayerToken = null;
        let hostSecretNumbers = []; // Array for all rounds
        let hostRevealState = 'initial';
        let playersRevealState = 'initial';
        let nextRoundState = 'initial';
        let playerNextRoundState = 'initial';
        let playerCurrentRound = 1; // Independent player round counter
        let gameState = {
            currentRound: 1,
            currentTurn: 1, // 1 = Player 1, 2 = Player 2, etc., 0 = Host
            maxPlayers: 0,
            scores: {},
            maxRounds: 10
        };

        // Available letters (excluding I and L for clarity)
        const AVAILABLE_LETTERS = 'ABCDEFGHJKMNOPQRSTUVWXYZ'; // 24 letters

        // Simple category list
        const categories = [
            "Movies", "TV Shows", "Songs", "Video Games", "Books", "Actors/Actresses", "Musicians/Bands", 
            "Anime", "YouTubers", "Podcasts", "Food", "Desserts", "Pizza Toppings", "Drinks", "Restaurants", 
            "Ice Cream Flavors", "Breakfast Foods", "Snacks", "Fast Food Chains", "Cuisines", "Sports", 
            "Hobbies", "Exercise Activities", "Party Games", "Weekend Activities", "Vacation Destinations", 
            "Board Games", "Outdoor Activities", "Art Forms", "Dance Styles", "School Subjects", "Jobs/Careers", 
            "Animals", "Colors", "Seasons", "Weather Types", "Transportation", "Apps", "Social Media Platforms", 
            "Clothing Brands", "Superpowers", "Disney Characters", "Car Brands", "Countries", "Celebrities", 
            "Fashion Trends", "Room Decorations", "Study Methods", "Morning Routines", "Emotions"
        ];

        /**
         * Smart Algorithm: Convert 4-letter code to seed for deterministic random number generation
         */
        
        function generateSimpleToken() {
            // Generate 4 random letters only
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += AVAILABLE_LETTERS[Math.floor(Math.random() * AVAILABLE_LETTERS.length)];
            }
            return code;
        }

        function codeToSeed(fourLetterCode) {
            // Convert 4-letter code to base-24 number as seed
            let seed = 0;
            for (let i = 0; i < fourLetterCode.length; i++) {
                const letterIndex = AVAILABLE_LETTERS.indexOf(fourLetterCode[i]);
                seed = seed * 24 + letterIndex;
            }
            // Ensure seed is positive and reasonable
            return Math.abs(seed) + 1;
        }

        function seedRandom(seed) {
            // Simple linear congruential generator for deterministic random numbers
            let state = seed;
            return function() {
                state = (state * 1664525 + 1013904223) % Math.pow(2, 32);
                return (state / Math.pow(2, 32));
            };
        }

        function generateSecretNumbers(fourLetterCode, maxRounds) {
            const seed = codeToSeed(fourLetterCode);
            const rng = seedRandom(seed);
            
            const secretNumbers = [];
            for (let i = 0; i < maxRounds; i++) {
                // Generate number between 1-10
                const number = Math.floor(rng() * 10) + 1;
                secretNumbers.push(number);
            }
            return secretNumbers;
        }

        function decodeToken(token) {
            if (!token || token.length !== 4) {
                return null;
            }
            
            // Verify all letters are valid
            for (let letter of token) {
                if (!AVAILABLE_LETTERS.includes(letter)) {
                    return null;
                }
            }
            
            return generateSecretNumbers(token, gameState.maxRounds);
        }

        function selectRole(role) {
            currentScreen = role;
            hideAllScreens();
            
            if (role === 'host') {
                document.getElementById('hostScreen').classList.remove('hidden');
            } else {
                document.getElementById('playerScreen').classList.remove('hidden');
            }
            
            showBackButton();
        }

        function generateCodes() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            
            if (playerCount < 1 || playerCount > 50) {
                alert('Please enter a number between 1 and 50 players.');
                return;
            }

            playerTokens = {};
            gameState.maxPlayers = playerCount;
            gameState.scores = { 'Host': 0 };

            // Generate host secret numbers using a random 4-letter code
            const hostCode = Array.from({length: 4}, () => 
                AVAILABLE_LETTERS[Math.floor(Math.random() * AVAILABLE_LETTERS.length)]
            ).join('');
            hostSecretNumbers = generateSecretNumbers(hostCode, gameState.maxRounds);

            // Generate tokens for other players
            for (let i = 1; i <= playerCount; i++) {
                const token = generateSimpleToken();
                const secretNumbers = generateSecretNumbers(token, gameState.maxRounds);
                
                playerTokens[token] = {
                    playerNumber: i,
                    secretNumbers: secretNumbers
                };
                
                gameState.scores[`Player ${i}`] = 0;
            }

            showCodesScreen();
        }

        function showCodesScreen() {
            const codesContainer = document.getElementById('codesContainer');
            codesContainer.innerHTML = '';

            // Display all player codes with just the 4 letters
            for (const [token, data] of Object.entries(playerTokens)) {
                const codeItem = document.createElement('div');
                codeItem.className = 'qr-item';
                codeItem.innerHTML = `
                    <h3>Player ${data.playerNumber}</h3>
                    <div class="token">${token}</div>
                    <small>Give this code to Player ${data.playerNumber}</small>
                `;
                codesContainer.appendChild(codeItem);
            }

            generateQRCode();
            
            hideAllScreens();
            document.getElementById('hostCodesScreen').classList.remove('hidden');
            currentScreen = 'hostCodes';
        }

        function startGame() {
            hideAllScreens();
            document.getElementById('hostGameScreen').classList.remove('hidden');
            currentScreen = 'hostGame';
            
            updateGameDisplay();
            updateScoreboard();
        }

        function updateGameDisplay() {
            document.getElementById('currentRound').textContent = gameState.currentRound;
            document.getElementById('hostRoundDisplay').textContent = gameState.currentRound;
            document.getElementById('revealRoundDisplay').textContent = gameState.currentRound;
            
            const currentPlayerName = gameState.currentTurn === 0 ? 'Host' : `Player ${gameState.currentTurn}`;
            document.getElementById('categoryPlayerName').textContent = currentPlayerName;
            
            // Update host's current number
            document.getElementById('hostSecret').textContent = hostSecretNumbers[gameState.currentRound - 1];
            
            resetHostRevealButton();
            resetNextRoundButton();
        }

        function generateQRCode() {
            const currentURL = window.location.href;
            const canvas = document.getElementById('qrCanvas');
            
            if (typeof QRCode !== 'undefined') {
                QRCode.toCanvas(canvas, currentURL, { width: 200 }, function (error) {
                    if (error) console.error('QR Code generation failed:', error);
                });
            } else {
                // Fallback if QR library fails to load
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 200;
                ctx.fillStyle = '#333';
                ctx.fillRect(0, 0, 200, 200);
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('QR Code', 100, 90);
                ctx.fillText('Failed to Load', 100, 110);
                ctx.fillText('Share URL manually', 100, 130);
            }
        }

        function toggleQRCode() {
            const container = document.getElementById('qrCodeContainer');
            const toggleText = document.getElementById('qrToggleText');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                toggleText.textContent = 'Hide QR Code';
            } else {
                container.classList.add('hidden');
                toggleText.textContent = 'Show QR Code';
            }
        }

        function updateScoreboard() {
            const container = document.getElementById('scoreboardContainer');
            container.innerHTML = '';
            
            for (const [playerName, score] of Object.entries(gameState.scores)) {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                
                const currentPlayerName = gameState.currentTurn === 0 ? 'Host' : `Player ${gameState.currentTurn}`;
                if (playerName === currentPlayerName) {
                    scoreItem.classList.add('current-turn');
                }
                
                scoreItem.innerHTML = `
                    <div class="player-name">${playerName}</div>
                    <div class="score-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustScore('${playerName}', -1)">-</button>
                        <div class="score-display">${score}</div>
                        <button class="btn btn-success btn-small" onclick="adjustScore('${playerName}', 1)">+</button>
                    </div>
                `;
                
                container.appendChild(scoreItem);
            }
        }

        function adjustScore(playerName, delta) {
            gameState.scores[playerName] = Math.max(0, gameState.scores[playerName] + delta);
            updateScoreboard();
        }

        function nextTurn() {
            gameState.currentTurn++;
            if (gameState.currentTurn > gameState.maxPlayers) {
                gameState.currentTurn = 0; // Host's turn
            }
            updateGameDisplay();
            updateScoreboard();
            
            // Clear the current subject
            document.getElementById('currentSubject').textContent = 'Click below to generate a category!';
        }

        function confirmNextRound() {
            const btn = document.getElementById('nextRoundBtn');
            
            if (nextRoundState === 'initial') {
                if (gameState.currentRound >= gameState.maxRounds) {
                    alert(`Maximum ${gameState.maxRounds} rounds reached!`);
                    return;
                }
                
                nextRoundState = 'confirming';
                btn.textContent = 'Are you sure? Click again';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (nextRoundState === 'confirming') {
                        resetNextRoundButton();
                    }
                }, 3000);
                
            } else if (nextRoundState === 'confirming') {
                nextRound();
            }
        }

        function resetNextRoundButton() {
            nextRoundState = 'initial';
            const btn = document.getElementById('nextRoundBtn');
            btn.textContent = 'Next Round';
            btn.className = 'btn btn-info';
        }

        function nextRound() {
            gameState.currentRound++;
            gameState.currentTurn = 1; // Start with Player 1
            updateGameDisplay();
            updateScoreboard();
            
            // Clear the current subject
            document.getElementById('currentSubject').textContent = 'Click below to generate a category!';
            
            // Hide host number and reset reveal state
            document.getElementById('hostNumberDisplay').classList.add('hidden');
            hostRevealState = 'initial';
            resetHostRevealButton();
            
            // Hide revealed numbers if showing
            hideRevealedNumbers();
            playersRevealState = 'initial';
            resetPlayersRevealButton();
        }

        function confirmHostReveal() {
            const btn = document.getElementById('hostRevealBtn');
            
            if (hostRevealState === 'initial') {
                hostRevealState = 'confirming';
                btn.textContent = 'Are you sure? Click again to reveal';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (hostRevealState === 'confirming') {
                        resetHostRevealButton();
                    }
                }, 3000);
                
            } else if (hostRevealState === 'confirming') {
                hostRevealState = 'revealed';
                document.getElementById('hostNumberDisplay').classList.remove('hidden');
                btn.textContent = 'Number Revealed';
                btn.className = 'btn btn-secondary';
                btn.disabled = true;
            }
        }

        function hideHostNumber() {
            document.getElementById('hostNumberDisplay').classList.add('hidden');
            hostRevealState = 'initial';
            resetHostRevealButton();
        }

        function resetHostRevealButton() {
            hostRevealState = 'initial';
            const btn = document.getElementById('hostRevealBtn');
            btn.textContent = 'Show My Number for This Round';
            btn.className = 'btn btn-warning';
            btn.disabled = false;
        }

        function confirmPlayersReveal() {
            const btn = document.getElementById('playersRevealBtn');
            
            if (playersRevealState === 'initial') {
                playersRevealState = 'confirming';
                btn.textContent = 'Are you sure? Click again to reveal all';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (playersRevealState === 'confirming') {
                        resetPlayersRevealButton();
                    }
                }, 3000);
                
            } else if (playersRevealState === 'confirming') {
                playersRevealState = 'revealed';
                revealAllNumbers();
                btn.textContent = 'All Numbers Revealed';
                btn.className = 'btn btn-secondary';
                btn.disabled = true;
                
                // Show hide button
                document.getElementById('hideRevealBtn').classList.remove('hidden');
            }
        }

        function resetPlayersRevealButton() {
            playersRevealState = 'initial';
            const btn = document.getElementById('playersRevealBtn');
            btn.textContent = 'Reveal All Numbers (Current Round)';
            btn.className = 'btn btn-danger';
            btn.disabled = false;
        }

        function revealAllNumbers() {
            const revealContainer = document.getElementById('revealedNumbers');
            revealContainer.innerHTML = '';
            
            for (const [token, data] of Object.entries(playerTokens)) {
                const currentNumber = data.secretNumbers[gameState.currentRound - 1];
                const revealItem = document.createElement('div');
                revealItem.className = 'revealed-item';
                revealItem.innerHTML = `
                    <div class="player-name">Player ${data.playerNumber}</div>
                    <div class="secret-num">${currentNumber}</div>
                    <small>Round ${gameState.currentRound}</small>
                `;
                revealContainer.appendChild(revealItem);
            }
            
            revealContainer.classList.remove('hidden');
        }

        function hideRevealedNumbers() {
            document.getElementById('revealedNumbers').classList.add('hidden');
            document.getElementById('hideRevealBtn').classList.add('hidden');
            playersRevealState = 'initial';
            resetPlayersRevealButton();
        }

        function validateToken() {
            const token = document.getElementById('playerToken').value.toUpperCase().trim();
            
            if (!token) {
                alert('Please enter a 4-letter code.');
                return;
            }

            if (token.length !== 4) {
                alert('Code must be exactly 4 letters.');
                return;
            }

            // Find player by token
            let foundPlayer = null;
            for (const [playerToken, data] of Object.entries(playerTokens)) {
                if (playerToken === token) {
                    foundPlayer = data;
                    break;
                }
            }

            if (foundPlayer) {
                currentPlayerNumber = foundPlayer.playerNumber;
                currentPlayerToken = token;
                showRules();
                return;
            }

            // Verify all letters are valid
            let validCode = true;
            for (let letter of token) {
                if (!AVAILABLE_LETTERS.includes(letter)) {
                    validCode = false;
                    break;
                }
            }
            
            if (validCode) {
                // Use a default player number for demo
                currentPlayerNumber = 1;
                currentPlayerToken = token;
                showRules();
            } else {
                alert('Invalid letters in code. Please check and try again.');
            }
        }

        function showRules() {
            hideAllScreens();
            document.getElementById('rulesScreen').classList.remove('hidden');
            document.getElementById('playerNumberDisplay').textContent = `You are Player ${currentPlayerNumber}`;
        }

        function enterGame() {
            hideAllScreens();
            document.getElementById('playerGameScreen').classList.remove('hidden');
            document.getElementById('playerTitle').textContent = `Player ${currentPlayerNumber}`;
            playerCurrentRound = 1; // Reset to round 1 when entering game
            updatePlayerGameDisplay();
        }

        function updatePlayerGameDisplay() {
            let currentNumber;
            
            if (currentPlayerToken && playerTokens[currentPlayerToken]) {
                currentNumber = playerTokens[currentPlayerToken].secretNumbers[playerCurrentRound - 1];
            } else {
                const decodedNumbers = decodeToken(currentPlayerToken);
                currentNumber = decodedNumbers ? decodedNumbers[playerCurrentRound - 1] : Math.floor(Math.random() * 10) + 1;
            }
            
            document.getElementById('playerSecretNumber').textContent = currentNumber;
            document.getElementById('playerCurrentRound').textContent = playerCurrentRound;
        }

        function animateNumberChange() {
            const numberElement = document.getElementById('playerSecretNumber');
            
            // Add animation classes
            numberElement.classList.add('number-changing', 'sparkle-effect');
            
            // Remove animation classes after animation completes
            setTimeout(() => {
                numberElement.classList.remove('number-changing', 'sparkle-effect');
            }, 1000);
        }

        function confirmPlayerNextRound() {
            const btn = document.getElementById('playerNextRoundBtn');
            
            if (playerNextRoundState === 'initial') {
                if (playerCurrentRound >= gameState.maxRounds) {
                    alert(`Maximum ${gameState.maxRounds} rounds reached!`);
                    return;
                }
                
                playerNextRoundState = 'confirming';
                btn.textContent = 'Are you sure? Click again';
                btn.className = 'btn btn-confirm';
                
                setTimeout(() => {
                    if (playerNextRoundState === 'confirming') {
                        resetPlayerNextRoundButton();
                    }
                }, 3000);
                
            } else if (playerNextRoundState === 'confirming') {
                playerNextRound();
            }
        }

        function resetPlayerNextRoundButton() {
            playerNextRoundState = 'initial';
            const btn = document.getElementById('playerNextRoundBtn');
            btn.textContent = 'Next Round';
            btn.className = 'btn btn-info';
        }

        function playerNextRound() {
            // Advance to next round independently
            playerCurrentRound++;
            playerNextRoundState = 'initial';
            resetPlayerNextRoundButton();
            
            // Animate the number change
            animateNumberChange();
            
            // Update display with new number from algorithm
            setTimeout(() => {
                updatePlayerGameDisplay();
            }, 400); // Delay to sync with animation
        }

        function generateRandomSubject() {
            const randomIndex = Math.floor(Math.random() * categories.length);
            const category = categories[randomIndex];
            document.getElementById('currentSubject').textContent = category;
        }

        function hideAllScreens() {
            const screens = ['welcomeScreen', 'hostScreen', 'hostCodesScreen', 'hostGameScreen', 'playerScreen', 'playerGameScreen', 'rulesScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function showBackButton() {
            document.getElementById('backBtn').classList.remove('hidden');
        }

        function hideBackButton() {
            document.getElementById('backBtn').classList.add('hidden');
        }

        function goBack() {
            if (currentScreen === 'host' || currentScreen === 'player') {
                hideAllScreens();
                hideBackButton();
                document.getElementById('welcomeScreen').classList.remove('hidden');
                currentScreen = 'welcome';
            } else if (currentScreen === 'hostCodes') {
                hideAllScreens();
                document.getElementById('hostScreen').classList.remove('hidden');
                currentScreen = 'host';
            } else if (currentScreen === 'hostGame') {
                hideAllScreens();
                document.getElementById('hostCodesScreen').classList.remove('hidden');
                currentScreen = 'hostCodes';
            } else if (currentScreen === 'rules') {
                hideAllScreens();
                document.getElementById('playerScreen').classList.remove('hidden');
                currentScreen = 'player';
            }
        }

        // Event listeners
        document.getElementById('playerCount').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') generateCodes();
        });

        document.getElementById('playerToken').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') validateToken();
        });

        // Auto-format player token input to 4 letters only
        document.getElementById('playerToken').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase();
            
            // Remove invalid characters - only allow valid letters
            value = value.replace(/[^ABCDEFGHJKMNOPQRSTUVWXYZ]/g, '');
            
            // Limit to 4 characters
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            e.target.value = value;
        });
    </script>
</body>
</html>
